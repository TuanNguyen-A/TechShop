<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin</title>

    <script src="../../public/common/js/utility.js"></script>
    <script src="../../public/admin/js/config.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-fQybjgWLrvvRgtW6bFlB7jaZrFsaBXjsOMm/tB9LTS58ONXgqbR9W8oWht/amnpF"
        crossorigin="anonymous"></script>

</head>

<body>
    <div class="container-fluid d-flex">
        <iframe src="../layout/sidebar.html" frameborder=""></iframe>
        <div class="panel panel-primary">
            <div class="panel-heading">
                <div class="text-center">Product</div>
            </div>
            <div class="panel-body">
                <form action="">

                    <div class="form-group">
                        <label for="title">Title</label>
                        <input type="text" class="form-control" id="title" name="title" placeholder="Enter title">
                    </div>
                    <div class="form-group">
                        <label for="category_id">Category</label>
                        <div id="category_id">

                        </div>
                    </div>
                    <div class="form-group">
                        <label for="price">Price</label>
                        <input type="number" class="form-control" id="price" name="price" placeholder="Enter price">
                    </div>
                    <div class="form-group">
                        <label for="discount">Discount</label>
                        <input type="number" class="form-control" id="discount" name="discount"
                            placeholder="Enter discount (%)">
                    </div>
                    <div class="form-group">
                        <label for="quantity">Quantity</label>
                        <input type="number" class="form-control" id="quantity" name="quantity"
                            placeholder="Enter quantity">
                    </div>
                    <div class="form-group">
                        <label for="thumbnail">Thumbnail</label>
                        <input type="text" class="form-control" id="thumbnail" name="thumbnail"
                            placeholder="Enter thumbnail">
                        <div id="thumbnail_img"></div>
                    </div>
                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea name="description" class="form-control" id="description" rows="5"></textarea>
                    </div>

                    <button id="btn-submit" class="btn btn-primary">Add</button>
                </form>

            </div>
        </div>
    </div>



    <script type="text/javascript">
        $(function () {
            var id = '';
            var category_id = [];
            id = getUrlParameter('id');

            //Edit data
            if (id) {
                $.post(BASE_URL + API_PRODUCT, {
                    'action': QUERY,
                    'id': id
                }, function (data) {
                    var obj = JSON.parse(data);
                    if (obj.status == 1) {
                        var product = obj.product;
                        $("[name=title]").val(product.title);
                        $("[name=price]").val(product.price);
                        $("[name=discount]").val(product.discount);
                        $("[name=quantity]").val(product.quantity);
                        $("[name=thumbnail]").val(product.thumbnail);
                        $("[name=description]").val(product.description);
                        category_id = obj.categoryList;
                       console.log(obj.categoryList);
                        $("form").submit(function (e) {
                            var title = $("[name=title]").val();
                            var price = $("[name=price]").val();
                            var discount = $("[name=discount]").val();
                            var quantity = $("[name=quantity]").val();
                            var thumbnail = $("[name=thumbnail]").val();
                            var description = $("[name=description]").val();

                            $.post(BASE_URL + API_PRODUCT, {
                                'action': UPDATE,
                                'id': id,
                                'title': title,
                                'category_id': category_id,
                                'price': price,
                                'discount': discount,
                                'quantity': quantity,
                                'thumbnail': thumbnail,
                                'description': description
                            }, function (data) {
                                alert(data)
                                var obj = JSON.parse(data);
                                if (obj.status == 1) {
                                    window.open('show.html', '_self');
                                } else {
                                    alert(obj.msg);
                                }
                            });

                            return false;
                        })
                    } else {
                        id = '';
                    }
                })
            }


            //add new product
            if (id == '') {
                $('#btn-submit').on('click', function (e) {
                    var title = $("[name=title]").val();
                    var price = $("[name=price]").val();
                    var quantity = $("[name=quantity]").val();
                    var discount = $("[name=discount]").val();
                    var thumbnail = $("[name=thumbnail]").val();
                    var description = $("[name=description]").val();
                    var checkbox = $("[name=category_id]");
                    var category_id = [];

                    for (var i = 0; i < checkbox.length; i++) {
                        if (checkbox[i].checked === true) {
                            category_id.push(checkbox[i].value);
                        }
                    }


                    $.post(BASE_URL + API_PRODUCT, {
                        'action': ADD,
                        'title': title,
                        'price': price,
                        'quantity': quantity,
                        'discount': discount,
                        'thumbnail': thumbnail,
                        'description': description,
                        'category_id': category_id
                    }, function (data) {
                        alert(data);
                        var obj = JSON.parse(data);
                        if (obj.status == 1) {
                            window.open('show.html', '_self');
                        } else {
                            alert(obj.msg);
                        }
                    });
                })
            }

            //Category List
            $.post(BASE_URL + API_CATEGORY, {
                'action': LIST,
                'search': ''
            }, function (data) {
                var obj = JSON.parse(data);
                if (obj.status == 1) {
                    categoryList = obj.categoryList;
                    console.log(category_id)
                    console.log(categoryList)
                    for (i = 0; i < categoryList.length; i++) {
                        item = categoryList[i];
                        $('#category_id').append(`
                            <input type="checkbox" name="category_id" value="${item['id']}" ${category_id.includes(item['id']) ? 'checked' : ''}>${item['name']}
                            `);
                    }
                } else {
                    window.open('../authen/login.html', '_self');
                }
            });


            //Display thumbnail
            $('#thumbnail').on('change', function () {
                $('#thumbnail_img').html('');
                $('#thumbnail_img').append(`<img src="${$('#thumbnail').val()}" alt="thumbnail">`)
            })

            console.log()
        })
    </script>
</body>

</html>